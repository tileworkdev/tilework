[agent]
  debug = true



[[processors.starlark]]
  namepass = ["haproxy"]

  source = '''
TAGS_TO_DROP = ["server", "host", "proxy", "sv"]

def apply(metric):
    for k in TAGS_TO_DROP:
        metric.tags.pop(k, None)
    return metric
'''



[[processors.starlark]]
  namepass = ["haproxy"]
  fieldinclude = ["stot", "req_tot"]

  source = '''
state = {}

def apply(metric):
    # key per series: measurement + tags
    key = metric.name + "|" + str(sorted(metric.tags.items()))

    last = state.get(key)
    # store current metric for next time
    state[key] = deepcopy(metric)

    # First time we see this series: zero all numeric fields
    if last == None:
        for fname, val in metric.fields.items():
            t = type(val)
            if t == "int" or t == "float":
                metric.fields[fname] = 0
        return metric

    # Subsequent points: convert numeric fields to delta
    for fname, val in metric.fields.items():
        t = type(val)
        if not (t == "int" or t == "float"):
            continue

        # no previous value -> treat as first sample
        if fname not in last.fields:
            metric.fields[fname] = 0
            continue

        prev = last.fields[fname]
        pt = type(prev)
        if not (pt == "int" or pt == "float"):
            metric.fields[fname] = 0
            continue

        d = val - prev
        if d < 0:
            d = 0

        metric.fields[fname] = d

    return metric
'''

[[processors.rename]]
  namepass = ["haproxy"]

  [[processors.rename.replace]]
    field = "stot"
    dest = "sessions"

  [[processors.rename.replace]]
    field = "req_tot"
    dest = "requests"
