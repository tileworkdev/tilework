@using Tilework.LoadBalancing.Persistence.Models
@using Tilework.LoadBalancing.Enums

@inject LoadBalancerDetailViewModel ViewModel
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

@page "/lb/loadbalancers/{Id}"

<GenericDetailview Title="@ViewModel.Object.Name" Breadcrumbs="@_items" Actions="@_actions">
    <DetailContent>
        <MudGrid Spacing="5">
            <MudItem>
                <MudText Typo="Typo.subtitle2">Type</MudText>
                <MudText Typo="Typo.body2">@(ViewModel.Object is ApplicationLoadBalancer ? "Application" : "Network")</MudText>
            </MudItem>
            <MudItem>
                <MudText Typo="Typo.subtitle2">Status</MudText>
                @if (ViewModel.Object.Enabled)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Enabled</MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error">Disabled</MudChip>
                }
            </MudItem>
        </MudGrid>
    </DetailContent>
    <TabContent>
    </TabContent>
</GenericDetailview>



@code {
    [Parameter]
    public string Id { get; set; }

    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Load balancers", href: "/lb/loadbalancers", icon: Icons.Material.Filled.AltRoute)
    };

    private List<ActionItem> _actions = new List<ActionItem> {};

    protected override async Task OnInitializedAsync()
    {
        try {
            await ViewModel.Initialize(Guid.Parse(Id));
        }
        catch (KeyNotFoundException) {
            NavigationManager.NavigateTo("/lb/loadbalancers");
        }
        
        _items.Add(new BreadcrumbItem(ViewModel.Object.Name, href: null, disabled: true));

        _actions = new List<ActionItem>
        {
            new ActionItem() { Name="Edit", Href=$"/lb/loadbalancers/{Id}/edit" },
            new ActionItem() { Name="Delete", OnClick=ConfirmDelete },
            new ActionItem() {
                Name= ViewModel.Object.Enabled ? "Disable" : "Enable",
                OnClick= ViewModel.Object.Enabled ? ViewModel.Disable : ViewModel.Enable }
        };
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the load balancer? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = DialogService.Show<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await ViewModel.Delete();
            NavigationManager.NavigateTo("/lb/loadbalancers");
        }
    }
}