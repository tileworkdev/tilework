@using Tilework.LoadBalancing.Persistence.Models
@using Tilework.LoadBalancing.Enums

@inject LoadBalancerDetailViewModel ViewModel
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

@page "/lb/loadbalancers/{Id}"

<MudBreadcrumbs Items="_items" Separator=">"></MudBreadcrumbs>

<MudCard Outlined="true" Class="mb-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">@ViewModel.Object.Name</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                <MudMenuItem OnClick="@(() => NavigationManager.NavigateTo($"/lb/loadbalancers/{Id}/edit"))">Edit</MudMenuItem>
                <MudMenuItem OnClick="ConfirmDelete">Delete</MudMenuItem>
                @if (ViewModel.Object.Enabled == true)
                {
                    <MudMenuItem OnClick="ViewModel.Disable">Disable</MudMenuItem>
                }
                else
                {
                    <MudMenuItem OnClick="ViewModel.Enable">Enable</MudMenuItem>
                }
            </MudMenu>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudGrid Spacing="5">
            <MudItem>
                <MudText Typo="Typo.subtitle2">Type</MudText>
                <MudText Typo="Typo.body2">@ViewModel.Object.Type</MudText>
            </MudItem>
            <MudItem>
                <MudText Typo="Typo.subtitle2">Status</MudText>
                @if (ViewModel.Object.Enabled)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Enabled</MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error">Disabled</MudChip>
                }
            </MudItem>
        </MudGrid>
    </MudCardContent>
    <MudCardActions>
    </MudCardActions>
</MudCard>


<MudDataGrid T="Listener" Outlined="true" Items="ViewModel.Object.Listeners" Hover="true">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Listeners</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" DropShadow="false" Color="Color.Primary" OnClick="AddListener">Add Listener</MudButton>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="t => t.Port" Title="Port" Editable="false" />
        @if (ViewModel.Object.Type == LoadBalancerType.APPLICATION)
        {
            <PropertyColumn Property="t => t.AlbProtocol" Title="Protocol" Editable="false" />
        }
        else
        {
            <PropertyColumn Property="t => t.NlbProtocol" Title="Protocol" Editable="false" />
        }
        
        <PropertyColumn Property="t => t.Rules.Count()" Title="Rules" />
        <TemplateColumn CellClass="d-flex justify-end">
            <CellTemplate>
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>

@code {
    [Parameter]
    public string Id { get; set; }

    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Load balancers", href: "/lb/loadbalancers", icon: Icons.Material.Filled.AltRoute)
    };

    protected override async Task OnInitializedAsync()
    {
        try {
            await ViewModel.Initialize(Guid.Parse(Id));
        }
        catch {
            NavigationManager.NavigateTo("/lb/loadbalancers");
        }
        
        _items.Add(new BreadcrumbItem(ViewModel.Object.Name, href: null, disabled: true));
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the load balancer? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = DialogService.Show<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await ViewModel.Delete();
            NavigationManager.NavigateTo("/lb/loadbalancers");
        }
    }

    private async Task AddListener()
    {
    }
}