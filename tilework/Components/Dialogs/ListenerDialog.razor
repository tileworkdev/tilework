@using Tilework.LoadBalancing.Persistence.Models
@using Tilework.LoadBalancing.Enums
@using System.Net

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-3 mb-n1"/>
            Add Listener
        </MudText>
    </TitleContent>
    <DialogContent>
        @if(ViewModel.Object.Type == LoadBalancerType.APPLICATION)
        {
            <MudForm @ref="form">
                <MudTextField @bind-Value="@applicationListener.Port" Variant="Variant.Outlined" Label="Port"/>
                <MudSelect T="AlbProtocol" @bind-Value="@applicationListener.Protocol"
                           Label="Protocol" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Required="true">
                    <MudSelectItem Value="AlbProtocol.HTTP" />
                    <MudSelectItem Value="AlbProtocol.HTTPS" />
                </MudSelect>
            </MudForm>
        }
        else
        {
            <MudForm @ref="form">
                <MudTextField @bind-Value="@networkListener.Port" Variant="Variant.Outlined" Label="Port"/>
                <MudSelect T="NlbProtocol" @bind-Value="@networkListener.Protocol"
                           Label="Protocol" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Required="true">
                    <MudSelectItem Value="NlbProtocol.TCP" />
                    <MudSelectItem Value="NlbProtocol.UDP" />
                    <MudSelectItem Value="NlbProtocol.TCP_UDP" />
                    <MudSelectItem Value="NlbProtocol.TLS" />
                </MudSelect>
                <MudSelect T="TargetGroup" @bind-Value="networkListener.TargetGroup"
                        Label="Target group" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Required="true">
                    @foreach (var group in targetGroups)
                    {
                        <MudSelectItem T="TargetGroup" Value="@group">@group.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">Add</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    [Parameter] public LoadBalancerDetailViewModel ViewModel { get; set; }
    [Parameter] public Guid ListenerId { get; set; }

    private MudForm form;

    private ApplicationListener applicationListener = new ApplicationListener();
    private NetworkListener networkListener = new NetworkListener();

    private List<TargetGroup> targetGroups = new List<TargetGroup>();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        targetGroups = await ViewModel.GetTargetGroups();
    }

    async Task Submit()
    {
        await form.Validate();

        if(form.IsValid)
        {
            if(ViewModel.Object.Type == LoadBalancerType.APPLICATION)
                await ViewModel.AddListener(applicationListener);
            else
                await ViewModel.AddListener(networkListener);
                

            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    void Cancel() => MudDialog.Cancel();
}
