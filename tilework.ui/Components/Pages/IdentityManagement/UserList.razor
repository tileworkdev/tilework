@using Tilework.IdentityManagement.Models
@using Tilework.IdentityManagement.Services
@using Tilework.Ui.Services

@namespace Tilework.Ui.Components.Pages
@inject UserService _userService
@inject IBrowserTimeZoneProvider _browserTimezoneProvider


@page "/im/users"

<PageTitle>Users</PageTitle>

<GenericListview Title="Users" Items="@_items" Actions="@_actions" Breadcrumbs="@_breadcrumbs">
    <HeaderContent>
        <MudTh>Username</MudTh>
        <MudTh>Email</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Last login</MudTh>
        <MudTh>Creation time</MudTh>
    </HeaderContent>
    <RowContent>
        <MudTd DataLabel="Username"><MudLink Href="@($"/im/users/{context.Id}")">@context.UserName</MudLink></MudTd>
        <MudTd DataLabel="Email">@context.Email</MudTd>
        <MudTd DataLabel="Status">
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
            @if (context.Active)
            {
                <MudIcon Style="@($"color:{Colors.Green.Darken2};")"  Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Small"/>
                <MudText Style="@($"color:{Colors.Green.Darken2};")" Typo="Typo.body2">Enabled</MudText>
            }
            else
            {
                <MudIcon Style="@($"color:{Colors.Red.Darken2};")" Icon="@Icons.Material.Outlined.Cancel" Size="Size.Small"/>
                <MudText Style="@($"color:{Colors.Red.Darken2};")" Typo="Typo.body2">Disabled</MudText>
            }
            </MudStack>
        </MudTd>
        <MudTd DataLabel="Last login">@_browserTimezoneProvider.Localize(context.LastLoginAtUtc)</MudTd>
        <MudTd DataLabel="Creation time">@_browserTimezoneProvider.Localize(context.CreatedAtUtc)</MudTd>
    </RowContent>
</GenericListview>

@code {
    public List<UserDTO> _items { get; set; } = new();

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Users", href: "/im/users/", disabled: true, icon: Icons.Material.Filled.AltRoute),
    };

    private List<ActionItem> _actions = new List<ActionItem>
    {
        new ActionItem { Name = "Create new", Href = "/im/users/new" }
    };

    protected override async Task OnInitializedAsync()
    {
        _items = await _userService.GetUsers();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _browserTimezoneProvider.Initialize();
            StateHasChanged();
        }
    }
}    
