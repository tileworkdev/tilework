@using Tilework.IdentityManagement.Models
@using Tilework.IdentityManagement.Services
@using Tilework.Ui.Services

@namespace Tilework.Ui.Components.Pages

@inject UserService _userService
@inject NavigationManager _navigationManager
@inject IDialogService _dialogService
@inject ISnackbar _snackbar
@inject IBrowserTimeZoneProvider _browserTimezoneProvider

@page "/im/users/{Id:guid}"

<PageTitle>User details</PageTitle>
@if(_item != null)
{
    <GenericDetailview Title="@_item.UserName" Breadcrumbs="@_breadcrumbs" Actions="@_actions">
        <DetailContent>
            <MudGrid>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Username</MudText>
                    <MudText Typo="Typo.body2">@_item.UserName</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Status</MudText>
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    @if (@_item.Active)
                    {
                        <MudIcon Style="@($"color:{Colors.Green.Darken2};")"  Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Small"/>
                        <MudText Style="@($"color:{Colors.Green.Darken2};")" Typo="Typo.body2">Enabled</MudText>
                    }
                    else
                    {
                        <MudIcon Style="@($"color:{Colors.Red.Darken2};")" Icon="@Icons.Material.Outlined.Cancel" Size="Size.Small"/>
                        <MudText Style="@($"color:{Colors.Red.Darken2};")" Typo="Typo.body2">Disabled</MudText>
                    }
                    </MudStack>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Last login</MudText>
                    <MudText Typo="Typo.body2">@_browserTimezoneProvider.Localize(_item.LastLoginAtUtc)</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Email</MudText>
                    <MudText Typo="Typo.body2">@_item.Email</MudText>
                </MudItem>
                <MudItem xs="4">
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Creation time</MudText>
                    <MudText Typo="Typo.body2">@_browserTimezoneProvider.Localize(_item.CreatedAtUtc)</MudText>
                </MudItem>
            </MudGrid>
        </DetailContent>
    </GenericDetailview>
}


@code {
    [Parameter]
    public Guid Id { get; set; }

    private UserDTO _item;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Users", href: "/im/users", icon: Icons.Material.Filled.AltRoute)
    };

    private List<ActionItem> _actions = new List<ActionItem>();

    private async Task RefreshItem()
    {
        _item = await _userService.GetUser(Id);
        if(_item == null)
            throw new InvalidOperationException();

        SetActions();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await RefreshItem();
        }
        catch(InvalidOperationException)
        {
            return;
        }

        _breadcrumbs.Add(new BreadcrumbItem(_item.UserName, href: null, disabled: true));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        if(_item == null)
        {
            _snackbar.Add($"User {Id} not found", Severity.Error);
            _navigationManager.NavigateTo("/im/users");
            return;
        }

        await _browserTimezoneProvider.Initialize();
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the user? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try {
                await _userService.DeleteUser(_item.Id);
                _navigationManager.NavigateTo("/im/users");
                _snackbar.Add($"User deleted successfully", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to delete user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task Enable()
    {
        try {
            _item.Active = true;
            _item = await _userService.UpdateUser(_item);
            _snackbar.Add("User enabled successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            _snackbar.Add($"Failed to enable user: {ex.Message}", Severity.Error);
        }
        SetActions();
    }

    private async Task Disable()
    {
        try {
            _item.Active = false;
            _item = await _userService.UpdateUser(_item);
            _snackbar.Add("User disabled successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            _snackbar.Add($"Failed to disable user: {ex.Message}", Severity.Error);
        }

        SetActions();
    }

    private void SetActions()
    {
        _actions = new List<ActionItem>
        {
            new ActionItem() { Name="Edit", Href=$"/im/users/{Id}/edit" },
            new ActionItem() { Name="Delete", OnClick=ConfirmDelete },
            new ActionItem()
            {
                Name = _item.Active ? "Disable" : "Enable",
                OnClick = _item.Active ? Disable : Enable
            }
        };
    }
}
