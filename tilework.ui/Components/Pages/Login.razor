@page "/login"
@attribute [AllowAnonymous]
@layout BlankLayout
@using Microsoft.AspNetCore.WebUtilities

@inject NavigationManager NavigationManager

<PageTitle>Login</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraSmall" Class="d-flex align-center justify-center" Style="min-height: 100vh;">
    <MudPaper Class="pa-6" Outlined="true" Width="100%">
        <MudText Typo="Typo.h5" Class="pb-4">Sign in</MudText>

        <form method="post" action="/api/auth/login">
            <input type="hidden" name="ReturnUrl" value="@_returnUrl" />
            <MudTextField T="string"
                          Variant="Variant.Outlined"
                          Label="Username or email"
                          Name="UserNameOrEmail"
                          Required="true" />
            <MudTextField T="string"
                          Variant="Variant.Outlined"
                          Label="Password"
                          InputType="InputType.Password"
                          Name="Password"
                          Required="true" />

            @if (!string.IsNullOrEmpty(_error))
            {
                <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2">@_error</MudAlert>
            }

            <MudButton ButtonType="ButtonType.Submit"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       DropShadow="false"
                       FullWidth="true"
                       Class="mt-4">
                Sign in
            </MudButton>
        </form>
    </MudPaper>
</MudContainer>

@code {
    private string? _error;
    private string _returnUrl = "/";

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("error", out var value))
        {
            _error = value == "invalid"
                ? "Invalid username or password."
                : "Login failed. Please try again.";
        }

        if (query.TryGetValue("ReturnUrl", out var returnUrlValue) &&
            !string.IsNullOrWhiteSpace(returnUrlValue))
        {
            _returnUrl = returnUrlValue.ToString();
        }
    }
}
