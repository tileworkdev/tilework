@using System.Security.Cryptography
@using System.Security.Cryptography.X509Certificates
@using System.Text
@using Tilework.CertificateManagement.Models
@using Tilework.CertificateManagement.Interfaces
@using Tilework.CertificateManagement.Enums
@using Tilework.Core.Enums
@using Tilework.Ui.Services
@using Tilework.Ui.Utilities

@namespace Tilework.Ui.Components.Pages

@inject ICertificateManagementService _certificateManagementService
@inject NavigationManager _navigationManager
@inject IDialogService _dialogService
@inject ISnackbar _snackbar
@inject IBrowserTimeZoneProvider _browserTimezoneProvider
@inject DownloadService _downloadService

@page "/cm/certificates/{Id:guid}"

<PageTitle>Certificate details</PageTitle>
@if(_item != null)
{
    <GenericDetailview Title="@_item.Name" Breadcrumbs="@_breadcrumbs" Actions="@_actions">
        <DetailContent>
            <MudGrid>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">FQDN</MudText>
                    <MudText Typo="Typo.body2">@_item.Fqdn</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Not before</MudText>
                    <MudText Typo="Typo.body2">@DateTimeFormatting.FormatTimestamp(_browserTimezoneProvider.Localize(new DateTimeOffset(_item.CertificateData[0].NotBefore.ToUniversalTime())))</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Key algorithm</MudText>
                    <MudText Typo="Typo.body2">@_certificateManagementService.GetPrivateKey(_item.PrivateKey).Result?.Algorithm.GetDescription()</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Certificate authority</MudText>
                    <MudText Typo="Typo.body2">@_certificateManagementService.GeCertificateAuthority(_item.Authority).Result?.Name</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Expires at</MudText>
                    <MudText Typo="Typo.body2">@DateTimeFormatting.FormatTimestamp(_browserTimezoneProvider.Localize(_item.ExpiresAtUtc))</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Serial number</MudText>
                    <MudText Typo="Typo.body2">@_item.CertificateData[0].SerialNumber</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Status</MudText>
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    @if (_item.Status == CertificateStatus.NEW)
                    {
                        <MudIcon Style="@($"color:{Colors.Green.Darken2};")"  Icon="@Icons.Material.Outlined.AddCircleOutline" Size="Size.Small"/>
                        <MudText Style="@($"color:{Colors.Green.Darken2};")" Typo="Typo.body2">New</MudText>
                    }
                    else if(_item.Status == CertificateStatus.ACTIVE)
                    {
                        <MudIcon Style="@($"color:{Colors.Green.Darken2};")" Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Small"/>
                        <MudText Style="@($"color:{Colors.Green.Darken2};")" Typo="Typo.body2">Active</MudText>
                    }
                    else if(_item.Status == CertificateStatus.EXPIRED)
                    {
                        <MudIcon Style="@($"color:{Colors.Orange.Darken2};")" Icon="@Icons.Material.Outlined.ChangeCircle" Size="Size.Small"/>
                        <MudText Style="@($"color:{Colors.Orange.Darken2};")" Typo="Typo.body2">Expired</MudText>
                    }
                    else if(_item.Status == CertificateStatus.REVOKED)
                    {
                        <MudIcon Style="@($"color:{Colors.Red.Darken2};")" Icon="@Icons.Material.Outlined.Cancel" Size="Size.Small"/>
                        <MudText Style="@($"color:{Colors.Red.Darken2};")" Typo="Typo.body2">Revoked</MudText>
                    }
                    </MudStack>
                </MudItem>
            </MudGrid>
        </DetailContent>
    </GenericDetailview>
}


@code {
    [Parameter]
    public Guid Id { get; set; }

    private CertificateDTO _item;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Certificates", href: "/cm/certificates", icon: Icons.Material.Filled.AltRoute)
    };

    private List<ActionItem> _actions = new List<ActionItem>();

    private async Task RefreshItem()
    {
        _item = await _certificateManagementService.GetCertificate(Id);
        if(_item == null)
            throw new InvalidOperationException();

        SetActions();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await RefreshItem();
        }
        catch(InvalidOperationException)
        {

            return;
        }

        _breadcrumbs.Add(new BreadcrumbItem(_item.Name, href: null, disabled: true));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        if(_item == null)
        {
            _snackbar.Add($"Certificate {Id} not found", Severity.Error);
            _navigationManager.NavigateTo("/cm/certificates");
            return;
        }

        await _browserTimezoneProvider.Initialize();
        StateHasChanged();
    }

    private async Task ConfirmRevoke()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to revoke the certificate? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Revoke");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<ConfirmDialog>("Revoke", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try {
                await _certificateManagementService.RevokeCertificate(_item.Id);
                await RefreshItem();
                _snackbar.Add("Certificate revoked successfully!", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to add certificate authority: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the certificate? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try {
                await _certificateManagementService.DeleteCertificate(_item.Id);
                _navigationManager.NavigateTo("/cm/certificates");
                _snackbar.Add($"Certificate deleted successfully", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to delete certificate: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ConfirmRenew()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you want to renew the certificate?");
        parameters.Add(x => x.ButtonText, "Renew");
        parameters.Add(x => x.Color, Color.Primary);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = _dialogService.Show<ConfirmDialog>("Renew", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try {
                await _certificateManagementService.RenewCertificate(_item.Id);
                await RefreshItem();
                _snackbar.Add("Certificate renewed successfully!", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to renew certificate: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DownloadBundle()
    {
        if (_item == null || _item.CertificateData == null || _item.CertificateData.Count == 0)
        {
            _snackbar.Add("No certificate chain available to download.", Severity.Warning);
            return;
        }

        var bundle = new StringBuilder();
        foreach (var cert in _item.CertificateData)
        {
            var der = cert.Export(X509ContentType.Cert);
            var pem = PemEncoding.Write("CERTIFICATE", der);
            bundle.AppendLine(new string(pem));
        }

        var fileName = $"{SanitizeFileName(_item.Name)}.pem";
        var data = Encoding.UTF8.GetBytes(bundle.ToString());
        await _downloadService.DownloadAsync(fileName, "application/x-pem-file", data);
    }

    private static string SanitizeFileName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "certificate";

        var invalidChars = Path.GetInvalidFileNameChars();
        var sanitized = new StringBuilder(name.Length);
        foreach (var ch in name)
        {
            sanitized.Append(invalidChars.Contains(ch) ? '_' : ch);
        }

        return sanitized.ToString();
    }

    private void SetActions()
    {
        _actions = new List<ActionItem>();

        _actions.Add(new ActionItem() { Name = "Download", OnClick = DownloadBundle });
        _actions.Add(new ActionItem() { Name = "Renew", OnClick = ConfirmRenew });

        if(_item.Status == CertificateStatus.ACTIVE)
        {
            _actions.Add(new ActionItem() { Name = "Revoke", OnClick = ConfirmRevoke });
        }

        _actions.Add(new ActionItem() { Name = "Delete", OnClick = ConfirmDelete });
    }
}
