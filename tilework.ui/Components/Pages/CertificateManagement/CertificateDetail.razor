@using Tilework.CertificateManagement.Models
@using Tilework.CertificateManagement.Interfaces
@using Tilework.CertificateManagement.Enums

@namespace Tilework.Ui.Components.Pages

@inject ICertificateManagementService _certificateManagementService
@inject NavigationManager _navigationManager
@inject IDialogService _dialogService
@inject ISnackbar _snackbar

@page "/cm/certificates/{Id:guid}"

<PageTitle>Certificate details</PageTitle>

<GenericDetailview Title="@_item.Name" Breadcrumbs="@_breadcrumbs" Actions="@_actions">
    <DetailContent>
        <MudGrid Spacing="5">
            <MudItem>
                <MudText Typo="Typo.subtitle2">FQDN</MudText>
                <MudText Typo="Typo.body2">@_item.Fqdn</MudText>
            </MudItem>
            <MudItem>
                <MudText Typo="Typo.subtitle2">Authority</MudText>
                <MudText Typo="Typo.body2">@_certificateManagementService.GeCertificateAuthority(_item.Authority).Result?.Name</MudText>
            </MudItem>
            <MudItem>
                <MudText Typo="Typo.subtitle2">Status</MudText>
                <MudText Typo="Typo.body2">@_item.Status</MudText>
            </MudItem>
        </MudGrid>
    </DetailContent>
</GenericDetailview>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private CertificateDTO _item;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Certificates", href: "/cm/certificates", icon: Icons.Material.Filled.AltRoute)
    };

    private List<ActionItem> _actions = new List<ActionItem>();

    protected override async Task OnInitializedAsync()
    {
        _item = await _certificateManagementService.GetCertificate(Id);
        if (_item == null)
        {
            _navigationManager.NavigateTo("/cm/certificates");
            _snackbar.Add($"Certificate {Id} not found", Severity.Error);
            return;
        }

        _breadcrumbs.Add(new BreadcrumbItem(_item.Name, href: null, disabled: true));


        SetActions();
    }

    private async Task ConfirmRevoke()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to revoke the certificate? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Revoke");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = _dialogService.Show<ConfirmDialog>("Revoke", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try {
                await _certificateManagementService.RevokeCertificate(_item.Id);
                SetActions();
                _snackbar.Add("Certificate revoked successfully!", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to add certificate authority: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the certificate? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = _dialogService.Show<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try {
                await _certificateManagementService.DeleteCertificate(_item.Id);
                _navigationManager.NavigateTo("/cm/certificates");
                _snackbar.Add($"Certificate deleted successfully", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to delete certificate: {ex.Message}", Severity.Error);
            }
        }
    }

    private void SetActions()
    {
        _actions = new List<ActionItem>
        {
            new ActionItem() { Name = "Delete", OnClick = ConfirmDelete }
        };

        if(_item.Status == CertificateStatus.ACTIVE)
        {
            _actions.Add(new ActionItem() { Name = "Revoke", OnClick = ConfirmRevoke });
        }
    }
}
