@using Tilework.Core.CertificateManagement.Models
@using Tilework.Core.Interfaces
@using Tilework.Ui.Models
@using AutoMapper

@namespace Tilework.Ui.Components.Pages

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ICertificateManagementService CertificateManagementService
@inject IMapper Mapper

@page "/cm/authorities/new"

<GenericEditview T="NewAcmeCertificateAuthorityForm" Model="@form" Title="New certificate authority" Breadcrumbs="@_breadcrumbs"
                 OnCancel="@(async () => NavigationManager.NavigateTo("/cm/authorities"))"
                 OnValidSubmit="Submit" />

@code {
    NewAcmeCertificateAuthorityForm form = new();

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Certificate authorities", href: "/cm/authorities", icon: Icons.Material.Filled.AltRoute),
        new BreadcrumbItem("Create new", href: null, disabled: true, icon: Icons.Material.Filled.AltRoute)
    };

    private async Task Submit()
    {
        try
        {
            var authority = Mapper.Map<CertificateAuthorityDTO>(form);
            await CertificateManagementService.AddCertificateAuthority(authority);
            NavigationManager.NavigateTo("/cm/authorities");
            Snackbar.Add("Certificate authority added successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to add certificate authority: {ex.Message}", Severity.Error);
        }
    }
}

