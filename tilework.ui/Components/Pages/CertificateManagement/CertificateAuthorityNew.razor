@using AutoMapper

@using Tilework.CertificateManagement.Models
@using Tilework.CertificateManagement.Interfaces
@using Tilework.CertificateManagement.Enums
@using Tilework.Ui.Models

@namespace Tilework.Ui.Components.Pages

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ICertificateManagementService CertificateManagementService
@inject IMapper Mapper

@page "/cm/authorities/new"

@if(form is NewAcmeCertificateAuthorityForm acmeForm)
{
    <GenericEditview T="NewAcmeCertificateAuthorityForm" Model="@acmeForm" Title="New certificate authority" Breadcrumbs="@_breadcrumbs"
                    OnCancel="@(async () => NavigationManager.NavigateTo("/cm/authorities"))"
                    OnChange="@OnChange" OnValidSubmit="OnSubmit" />
}
else if(form is NewPredefinedAcmeCertificateAuthorityForm pdAcmeForm)
{
    <GenericEditview T="NewPredefinedAcmeCertificateAuthorityForm" Model="@pdAcmeForm" Title="New certificate authority" Breadcrumbs="@_breadcrumbs"
                    OnCancel="@(async () => NavigationManager.NavigateTo("/cm/authorities"))"
                    OnChange="@OnChange" OnValidSubmit="OnSubmit" />
}

@code {
    NewCertificateAuthorityForm form = new NewPredefinedAcmeCertificateAuthorityForm(){ Type = CertificateAuthorityType.LETSENCRYPT };

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Certificate authorities", href: "/cm/authorities", icon: Icons.Material.Filled.AltRoute),
        new BreadcrumbItem("Create new", href: null, disabled: true, icon: Icons.Material.Filled.AltRoute)
    };

    private static Type GetFormType(CertificateAuthorityType type)
    {
        return type switch
        {
            CertificateAuthorityType.ACME => typeof(NewAcmeCertificateAuthorityForm),
            CertificateAuthorityType.LETSENCRYPT => typeof(NewPredefinedAcmeCertificateAuthorityForm),
            _ => throw new ArgumentOutOfRangeException()
        };
    }


    private async Task OnChange((string PropertyName, object? Value) change)
    {
        if(change.PropertyName == "Type")
        {
            CertificateAuthorityType? value = (CertificateAuthorityType?) change.Value;

            if(value != null)
            {
                var newFormType = GetFormType((CertificateAuthorityType) value);
                form = (NewCertificateAuthorityForm) Mapper.Map(form, form.GetType(), newFormType);
            }
   
            StateHasChanged();
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            var authority = Mapper.Map<CertificateAuthorityDTO>(form);
            await CertificateManagementService.AddCertificateAuthority(authority);
            NavigationManager.NavigateTo("/cm/authorities");
            Snackbar.Add("Certificate authority added successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to add certificate authority: {ex.Message}", Severity.Error);
        }
    }
}

