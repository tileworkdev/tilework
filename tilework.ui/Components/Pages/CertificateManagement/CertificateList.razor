@using Tilework.CertificateManagement.Models
@using Tilework.CertificateManagement.Interfaces
@using Tilework.CertificateManagement.Enums
@using Tilework.Core.Enums
@using Tilework.Ui.Services
@using Tilework.Ui.Utilities


@namespace Tilework.Ui.Components.Pages

@inject ICertificateManagementService _certificateManagementService
@inject NavigationManager _navigationManager
@inject IBrowserTimeZoneProvider _browserTimezoneProvider


@page "/cm/certificates"

<PageTitle>Certificates</PageTitle>

<GenericListview Title="Certificates" Items="@_items" Actions="@_actions" Breadcrumbs="@_breadcrumbs">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>FQDN</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Key algorithm</MudTh>
        <MudTh>Expiration</MudTh>
        <MudTh>Intermediate certificates</MudTh>
        <MudTh>Certificate authority</MudTh>
    </HeaderContent>
    <RowContent>
        <MudTd DataLabel="Name"><MudLink Href="@($"/cm/certificates/{context.Id}")">@context.Name</MudLink></MudTd>
        <MudTd DataLabel="FQDN">@context.Fqdn</MudTd>
        <MudTd DataLabel="Status">
            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
            @if (context.Status == CertificateStatus.NEW)
            {
                <MudIcon Style="@($"color:{Colors.Green.Darken2};")"  Icon="@Icons.Material.Outlined.AddCircleOutline" Size="Size.Small"/>
                <MudText Style="@($"color:{Colors.Green.Darken2};")" Typo="Typo.body2">New</MudText>
            }
            else if(context.Status == CertificateStatus.ACTIVE)
            {
                <MudIcon Style="@($"color:{Colors.Green.Darken2};")" Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Small"/>
                <MudText Style="@($"color:{Colors.Green.Darken2};")" Typo="Typo.body2">Active</MudText>
            }
            else if(context.Status == CertificateStatus.EXPIRED)
            {
                <MudIcon Style="@($"color:{Colors.Orange.Darken2};")" Icon="@Icons.Material.Outlined.ChangeCircle" Size="Size.Small"/>
                <MudText Style="@($"color:{Colors.Orange.Darken2};")" Typo="Typo.body2">Expired</MudText>
            }
            else if(context.Status == CertificateStatus.REVOKED)
            {
                <MudIcon Style="@($"color:{Colors.Red.Darken2};")" Icon="@Icons.Material.Outlined.Cancel" Size="Size.Small"/>
                <MudText Style="@($"color:{Colors.Red.Darken2};")" Typo="Typo.body2">Revoked</MudText>
            }
            </MudStack>
        </MudTd>
        <MudTd DataLabel="Key algorithm">@_certificateManagementService.GetPrivateKey(context.PrivateKey).Result?.Algorithm.GetDescription()</MudTd>
        <MudTd DataLabel="Expiration">@DateTimeFormatting.FormatTimestamp(_browserTimezoneProvider.Localize(context.ExpiresAtUtc))</MudTd>
        <MudTd DataLabel="Intermediate certificates">@(context.CertificateData.Count > 0 ? context.CertificateData.Count - 1 : 0)</MudTd>
        <MudTd DataLabel="CA">@_certificateManagementService.GeCertificateAuthority(context.Authority).Result?.Name</MudTd>
    </RowContent>
</GenericListview>

@code {
    public List<CertificateDTO> _items { get; set; } = new();

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Certificates", href: "/cm/certificates/", disabled: true, icon: Icons.Material.Filled.VerifiedUser),
    };

    private List<ActionItem> _actions = new List<ActionItem>
    {
        new ActionItem { Name = "Create new", Href = "/cm/certificates/new" }
    };

    protected override async Task OnInitializedAsync()
    {
        _items = await _certificateManagementService.GetCertificates();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _browserTimezoneProvider.Initialize();
            StateHasChanged();
        }
    }
}    
