@using Tilework.CertificateManagement.Enums
@using Tilework.CertificateManagement.Persistence.Models

@inject CertificateNewViewModel ViewModel
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

@page "/cm/certificates/new"

<GenericEditview Title="New certificate" Breadcrumbs="@_items"
                 OnCancel="@(async () => NavigationManager.NavigateTo("/cm/certificates"))"
                 OnValidSubmit="Submit">
    <FormContent>
        <MudTextField Class="mb-5" @bind-Value="ViewModel.Object.Name"
                      Label="Name" Variant="Variant.Outlined" Required="true" />
        <MudTextField Class="mb-5" @bind-Value="ViewModel.Object.Fqdn"
                      Label="FQDN" Variant="Variant.Outlined" Required="true" />
        <MudSelect T="KeyAlgorithm" @bind-Value="@ViewModel.Object.Algorithm"
                    Label="Key algorithm" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Required="true">
            <MudSelectItem Value="KeyAlgorithm.RSA_2048" />
            <MudSelectItem Value="KeyAlgorithm.RSA_3072" />
            <MudSelectItem Value="KeyAlgorithm.RSA_4096" />
            <MudSelectItem Value="KeyAlgorithm.ECDSA_P256" />
            <MudSelectItem Value="KeyAlgorithm.ECDSA_P384" />
        </MudSelect>
            <MudSelect T="CertificateAuthority" @bind-Value="ViewModel.Object.Authority"
                    Label="Certificate authority" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Required="true">
                @foreach (var ca in ViewModel.Authorities)
                {
                    <MudSelectItem T="CertificateAuthority" Value="@ca">@ca.Name</MudSelectItem>
                }
            </MudSelect>
    </FormContent>
</GenericEditview>

@code {
    private List<BreadcrumbItem> _items = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Certificates", href: "/cm/certificates", icon: Icons.Material.Filled.AltRoute),
        new BreadcrumbItem("Create new", href: null, disabled: true, icon: Icons.Material.Filled.AltRoute)
    };

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.Initialize();
    }

    private async Task Submit()
    {
        try
        {
            await ViewModel.Save();
            NavigationManager.NavigateTo("/cm/certificates");
            Snackbar.Add("Certificate added successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to add certificate: {ex.Message}", Severity.Error);
        }
    }
}