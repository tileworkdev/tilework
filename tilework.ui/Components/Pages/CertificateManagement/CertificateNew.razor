@using System.Linq
@using Tilework.CertificateManagement.Enums
@using Tilework.CertificateManagement.Models
@using Tilework.CertificateManagement.Interfaces
@using Tilework.Ui.Models

@namespace Tilework.Ui.Components.Pages

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ICertificateManagementService CertificateManagementService

@page "/cm/certificates/new"

<PageTitle>New certificate</PageTitle>

<GenericEditview Models="@(new EditFormModel[] { new EditFormModel(form) })" Title="New certificate" Breadcrumbs="@_breadcrumbs"
                 OnCancel="@(async () => NavigationManager.NavigateTo("/cm/certificates"))"
                 OnValidSubmit="Submit" />

@code {
    NewCertificateForm form = new NewCertificateForm();

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Certificates", href: "/cm/certificates", icon: Icons.Material.Filled.AltRoute),
        new BreadcrumbItem("Create new", href: null, disabled: true, icon: Icons.Material.Filled.AltRoute)
    };

    protected override async Task OnInitializedAsync()
    {
        var authorities = await CertificateManagementService.GetCertificateAuthorities();
        var authorityOptions = authorities.Select(ca => new SelectOptionItem
        {
            Value = ca.Id,
            Text = ca.Name
        }).ToList();

        form.SetOptions(nameof(NewCertificateForm.Authority), authorityOptions);
    }

    private async Task Submit()
    {
        try
        {
            await CertificateManagementService.AddCertificate(form.Name, form.Fqdn, form.Algorithm, (Guid) form.Authority!);
            NavigationManager.NavigateTo("/cm/certificates");
            Snackbar.Add("Certificate added successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to add certificate: {ex.Message}", Severity.Error);
        }
    }
}
