@using System.Linq
@using Tilework.Core.Enums
@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Models
@using Tilework.LoadBalancing.Interfaces
@using AutoMapper

@using Tilework.Ui.Models

@namespace Tilework.Ui.Components.Pages

@inject NavigationManager _navigationManager
@inject ISnackbar _snackbar
@inject ILoadBalancerService _loadBalancerService
@inject IMapper _mapper


@page "/lb/targetgroups/new"

<PageTitle>New target group</PageTitle>

<GenericEditview Models="@(new EditFormModel[] { new EditFormModel(form) })" Title="New target group" Breadcrumbs="@_breadcrumbs"
                 OnCancel="@(async () => _navigationManager.NavigateTo("/lb/targetgroups"))"
                 OnValidSubmit="Submit" />

@code {
    NewTargetGroupForm form = new NewTargetGroupForm();

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Target groups", href: "/lb/targetgroups", icon: Icons.Material.Filled.AltRoute),
        new BreadcrumbItem("Create new", href: null, disabled: true, icon: Icons.Material.Filled.AltRoute)
    };

    protected override Task OnInitializedAsync()
    {
        ConfigureProtocolOptions();
        return Task.CompletedTask;
    }

    private async Task Submit()
    {
        try
        {
            var obj = _mapper.Map<TargetGroupDTO>(form);
            await _loadBalancerService.AddTargetGroup(obj);
            _navigationManager.NavigateTo("/lb/targetgroups");
            _snackbar.Add("target group added successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            _snackbar.Add($"Failed to add target group: {ex.Message}", Severity.Error);
        }
    }

    private void ConfigureProtocolOptions()
    {
        var allowed = TargetGroupProtocolRules.GetAllowedProtocols();
        var options = allowed.Select(protocol => new SelectOptionItem
        {
            Value = protocol,
            Text = protocol.GetDescription()
        }).ToList();

        form.SetOptions(nameof(NewTargetGroupForm.Protocol), options);

        if (!allowed.Contains(form.Protocol))
            form.Protocol = allowed[0];
    }
}
