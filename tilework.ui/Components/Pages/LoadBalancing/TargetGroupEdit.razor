@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Services
@using Tilework.LoadBalancing.Persistence.Models
@using AutoMapper

@namespace Tilework.Ui.Components.Pages

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject LoadBalancerService LoadBalancerService
@inject IMapper _mapper

@page "/lb/targetgroups/{Id:guid}/edit"

<GenericEditview T="EditTargetGroupForm" Model="@form" Title="@Object.Name" 
                 OnCancel="@(async () => NavigationManager.NavigateTo("/lb/targetgroups"))"
                 OnValidSubmit="Submit" />

@code {
    [Parameter]
    public Guid Id { get; set; }

    private EditTargetGroupForm form = new EditTargetGroupForm();
    private TargetGroup Object;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Target groups", href: "/lb/targetgroups", icon: Icons.Material.Filled.AltRoute)
    };

    protected override async Task OnInitializedAsync()
    {
        try {
            Object = await LoadBalancerService.GetTargetGroup(Id);
            if (Object == null)
                throw new KeyNotFoundException();

            form = _mapper.Map<EditTargetGroupForm>(Object);
        }
        catch (KeyNotFoundException) {
            NavigationManager.NavigateTo("/lb/targetgroups");
            Snackbar.Add($"Target group {Id} not found", Severity.Error);
        }

        _breadcrumbs.Add(new BreadcrumbItem(Object.Name, href: $"/lb/targetgroups/{Id}"));
        _breadcrumbs.Add(new BreadcrumbItem("edit", href: null, disabled: true));
    }

    private async Task Submit()
    {
        try
        {
            Object = _mapper.Map(form, Object);
            await LoadBalancerService.UpdateTargetGroup(Object);
            await LoadBalancerService.ApplyConfiguration();

            NavigationManager.NavigateTo("/lb/targetgroups");
            Snackbar.Add("target group saved successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to save target group: {ex.Message}", Severity.Error);
        }
    }
}
