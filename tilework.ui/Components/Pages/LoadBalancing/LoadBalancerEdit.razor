@using AutoMapper

@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Services
@using Tilework.LoadBalancing.Persistence.Models

@namespace Tilework.Ui.Components.Pages

@inject LoadBalancerService LoadBalancerService
@inject NavigationManager NavigationManager
@inject IMapper _mapper
@inject ISnackbar Snackbar
@page "/lb/loadbalancers/{Id:guid}/edit"

@if(form is EditApplicationLoadBalancerForm albForm)
{
    <GenericEditview T="EditApplicationLoadBalancerForm" Model="@albForm" Title="Edit load balancer" Breadcrumbs="@_breadcrumbs"
                    OnCancel="@(async () => NavigationManager.NavigateTo("/lb/loadbalancers"))"
                    OnChange="@OnChange" OnValidSubmit="OnSubmit" />
}
else if(form is EditNetworkLoadBalancerForm nlbForm)
{
    <GenericEditview T="EditNetworkLoadBalancerForm" Model="@nlbForm" Title="Edit load balancer" Breadcrumbs="@_breadcrumbs"
                    OnCancel="@(async () => NavigationManager.NavigateTo("/lb/loadbalancers"))"
                    OnChange="@OnChange" OnValidSubmit="OnSubmit" />
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private EditBaseLoadBalancerForm form = new EditBaseLoadBalancerForm();

    private BaseLoadBalancer Object;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Load balancers", href: "/lb/loadbalancers", icon: Icons.Material.Filled.AltRoute)
    };

    protected override async Task OnInitializedAsync()
    {
        Object = await LoadBalancerService.GetLoadBalancer(Id);
        if (Object == null)
        {
            NavigationManager.NavigateTo("/lb/loadbalancers");
            Snackbar.Add($"Load balancer {Id} not found", Severity.Error);
        }

        if(Object is ApplicationLoadBalancer alb)
        {
            form = _mapper.Map<EditApplicationLoadBalancerForm>(alb);
        }
        else if(Object is NetworkLoadBalancer nlb)
        {
            form = _mapper.Map<EditNetworkLoadBalancerForm>(nlb);
        }


        _breadcrumbs.Add(new BreadcrumbItem(Object.Name, href: $"/lb/loadbalancers/{Id}"));
        _breadcrumbs.Add(new BreadcrumbItem("edit", href: null, disabled: true));        
    }

    private async Task OnChange((string PropertyName, object? Value) change)
    {
        if(change.PropertyName == "Type")
        {
            LoadBalancerType? value = (LoadBalancerType?) change.Value;
            if(value == LoadBalancerType.NETWORK && form is EditApplicationLoadBalancerForm albForm)
            {
                form = _mapper.Map<EditNetworkLoadBalancerForm>(albForm);

                var targetGroupOptions = (await LoadBalancerService.GetNlbTargetGroups()).Select(tg =>
                    new SelectOptionItem()
                    {
                        Value = tg.Id,
                        Text = tg.Name
                    }
                ).ToList();
                form.SetOptions(nameof(EditNetworkLoadBalancerForm.TargetGroup), targetGroupOptions);
            }
            else if(value == LoadBalancerType.APPLICATION && form is EditNetworkLoadBalancerForm nlbForm)
            {
                form = _mapper.Map<EditApplicationLoadBalancerForm>(nlbForm);
            }
                
            StateHasChanged();
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            Object = _mapper.Map(form, Object);
            await LoadBalancerService.UpdateLoadBalancer(Object);
            await LoadBalancerService.ApplyConfiguration();

            NavigationManager.NavigateTo("/lb/loadbalancers");
            Snackbar.Add("Load balancer saved successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to save load balancer: {ex.Message}", Severity.Error);
        }
    }
}