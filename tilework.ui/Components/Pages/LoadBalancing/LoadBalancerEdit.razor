@using AutoMapper

@using Tilework.Core.Enums
@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Models
@using Tilework.LoadBalancing.Interfaces
@using Tilework.Ui.Models

@namespace Tilework.Ui.Components.Pages

@inject ILoadBalancerService _loadBalancerService
@inject NavigationManager NavigationManager
@inject IMapper _mapper
@inject ISnackbar Snackbar
@page "/lb/loadbalancers/{Id:guid}/edit"

<PageTitle>Edit load balancer</PageTitle>

<GenericEditview Models="@(new EditFormModel[] { new EditFormModel(form) })" Title="Edit load balancer" Breadcrumbs="@_breadcrumbs"
                OnCancel="@(async () => NavigationManager.NavigateTo("/lb/loadbalancers"))"
                OnChange="@OnChange" OnValidSubmit="OnSubmit" />

@code {
    [Parameter]
    public Guid Id { get; set; }

    private EditLoadBalancerForm form = new EditLoadBalancerForm();

    private LoadBalancerDTO _item;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Load balancers", href: "/lb/loadbalancers", icon: Icons.Material.Filled.AltRoute)
    };

    protected override async Task OnInitializedAsync()
    {
        _item = await _loadBalancerService.GetLoadBalancer(Id);
        if (_item == null)
        {
            NavigationManager.NavigateTo("/lb/loadbalancers");
            Snackbar.Add($"Load balancer {Id} not found", Severity.Error);
        }

        form = _mapper.Map<EditLoadBalancerForm>(_item);
        ConfigureProtocolOptions();


        _breadcrumbs.Add(new BreadcrumbItem(_item.Name, href: $"/lb/loadbalancers/{Id}"));
        _breadcrumbs.Add(new BreadcrumbItem("edit", href: null, disabled: true));        
    }

    private async Task OnSubmit()
    {
        try
        {
            _item = _mapper.Map(form, _item);
            await _loadBalancerService.UpdateLoadBalancer(_item);
            await _loadBalancerService.ApplyConfiguration(_item.Id);

            NavigationManager.NavigateTo("/lb/loadbalancers");
            Snackbar.Add("Load balancer saved successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to save load balancer: {ex.Message}", Severity.Error);
        }
    }

    private Task OnChange((string PropertyName, object? Value) change)
    {
        if (change.PropertyName == nameof(EditLoadBalancerForm.Type))
        {
            ConfigureProtocolOptions();
            StateHasChanged();
        }

        return Task.CompletedTask;
    }

    private void ConfigureProtocolOptions()
    {
        var allowed = LoadBalancerProtocolRules.GetAllowedProtocols(form.Type);
        var options = allowed.Select(protocol => new SelectOptionItem
        {
            Value = protocol,
            Text = protocol.GetDescription()
        }).ToList();

        form.SetOptions(nameof(EditLoadBalancerForm.Protocol), options);

        if (!allowed.Contains(form.Protocol))
            form.Protocol = allowed[0];
    }
}
