@using System.Linq
@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Interfaces
@using Tilework.LoadBalancing.Models

@namespace Tilework.Ui.Components.Pages

@inject ILoadBalancerService _loadBalancerService
@inject NavigationManager _navigationManager
@inject IDialogService _dialogService
@inject ISnackbar _snackbar

@page "/lb/targetgroups/{Id:guid}"

<PageTitle>Target group details</PageTitle>
@if(_item != null)
{
    <GenericDetailview Title="@_item.Name" Breadcrumbs="@_breadcrumbs" Actions="@_actions">
        <DetailContent>
            <MudGrid>
                <MudItem xs="4">
                    <MudText Typo="Typo.subtitle2">Protocol</MudText>
                    <MudText Typo="Typo.body2">@_item.Protocol</MudText>
                </MudItem>
            </MudGrid>
        </DetailContent>
        <TabContent>
            <MudTabPanel Text="Targets">
                <MudDataGrid T="TargetDTO" Outlined="true" Items="_targets" Hover="true">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Targets</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Filled" DropShadow="false" Color="Color.Primary" OnClick="AddTarget">Add target</MudButton>
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Property="t => t.Host.Value" Title="Host" Editable="false" />
                        <PropertyColumn Property="t => t.Port" Title="Port" />
                        <TemplateColumn Title="Status">
                            <CellTemplate>
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                @{
                                    _targetHealth.TryGetValue(context.Item.Id, out var status);
                                    if (status == LoadBalancerStatus.UP)
                                    {
                                        <MudIcon Style="@($"color:{Colors.Green.Darken2};")"  Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Small"/>
                                        <MudText Style="@($"color:{Colors.Green.Darken2};")" Typo="Typo.body2">Up</MudText>
                                    }
                                    else if (status == LoadBalancerStatus.DOWN)
                                    {
                                        <MudIcon Style="@($"color:{Colors.Red.Darken2};")" Icon="@Icons.Material.Outlined.Cancel" Size="Size.Small"/>
                                        <MudText Style="@($"color:{Colors.Red.Darken2};")" Typo="Typo.body2">Down</MudText>
                                    }
                                    else
                                    {
                                        <MudIcon Style="@($"color:{Colors.Gray.Darken1};")" Icon="@Icons.Material.Outlined.ErrorOutline" Size="Size.Small"/>
                                        <MudText Style="@($"color:{Colors.Gray.Darken1};")" Typo="Typo.body2">Unknown</MudText>
                                    }
                                }
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn CellClass="d-flex justify-end">
                            <CellTemplate>
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@(() => EditTarget(context.Item))" />
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="@(() => ConfirmDeleteTarget(context.Item))" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudTabPanel>
        </TabContent>
    </GenericDetailview>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private TargetGroupDTO _item;
    private List<TargetDTO> _targets;
    private Dictionary<Guid, LoadBalancerStatus> _targetHealth = new();

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Target groups", href: "/lb/targetgroups", icon: Icons.Material.Filled.Storage)
    };

    private List<ActionItem> _actions = new List<ActionItem> {};

    protected override async Task OnInitializedAsync()
    {
        _item = await _loadBalancerService.GetTargetGroup(Id);
        if(_item == null)
        {
            return;
        }

        await GetTargets();

        _breadcrumbs.Add(new BreadcrumbItem(_item.Name, href: null, disabled: true));

        _actions = new List<ActionItem>
        {
            new ActionItem() { Name="Edit", Href=$"/lb/targetgroups/{Id}/edit" },
            new ActionItem() { Name="Delete", OnClick=ConfirmDelete }
        };

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        if(_item == null)
        {
            _snackbar.Add($"Target group {Id} not found", Severity.Error);
            _navigationManager.NavigateTo("/lb/targetgroups");
            return;
        }
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the target group? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try {
                await _loadBalancerService.DeleteTargetGroup(_item.Id);
                await _loadBalancerService.ApplyConfiguration();
                _navigationManager.NavigateTo("/lb/targetgroups");
                _snackbar.Add($"Target group deleted successfully", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to delete target group: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task AddTarget()
    {
        var target = new TargetDTO();
        var parameters = new DialogParameters<TargetDialog>();
        parameters.Add(x => x.Target, target);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<TargetDialog>("Add target", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await _loadBalancerService.AddTarget(_item, target);
            await GetTargets();
            await _loadBalancerService.ApplyConfiguration();
        }
    }

    private async Task EditTarget(TargetDTO target)
    {
        var targetEdit = new TargetDTO
        {
            Id = target.Id,
            Host = target.Host,
            Port = target.Port
        };

        var parameters = new DialogParameters<TargetDialog>();
        parameters.Add(x => x.Target, targetEdit);
        parameters.Add(x => x.Title, "Edit target");
        parameters.Add(x => x.ButtonText, "Save");
        parameters.Add(x => x.Icon, Icons.Material.Filled.Edit);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<TargetDialog>("Edit target", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await _loadBalancerService.UpdateTarget(_item, targetEdit);
            await GetTargets();
            await _loadBalancerService.ApplyConfiguration();
        }
    }

    private async Task ConfirmDeleteTarget(TargetDTO target)
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the target? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await _loadBalancerService.RemoveTarget(_item, target);
            await GetTargets();
            await _loadBalancerService.ApplyConfiguration();
        }
    }

    private async Task GetTargets()
    {
        if(_item != null)
        {
            _targets = await _loadBalancerService.GetTargets(_item);
            await LoadTargetHealth();
        }
    }

    private async Task LoadTargetHealth()
    {
        if (_targets == null || _targets.Count == 0)
        {
            _targetHealth = new Dictionary<Guid, LoadBalancerStatus>();
            return;
        }

        try
        {
            var healthTasks = _targets.Select(async target => new
            {
                target.Id,
                Status = await _loadBalancerService.GetTargetHealth(target.Id)
            });

            var results = await Task.WhenAll(healthTasks);
            _targetHealth = results.ToDictionary(result => result.Id, result => result.Status);
        }
        catch (Exception ex)
        {
            _snackbar.Add($"Failed to load target health: {ex.Message}", Severity.Error);
            _targetHealth = _targets.ToDictionary(target => target.Id, _ => LoadBalancerStatus.UNKNOWN);
        }
    }
}
