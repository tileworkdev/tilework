@using Tilework.LoadBalancing.Persistence.Models
@using Tilework.LoadBalancing.Services

@namespace Tilework.Ui.Components.Pages

@inject LoadBalancerService _loadBalancerService
@inject NavigationManager _navigationManager
@inject IDialogService _dialogService
@inject ISnackbar _snackbar

@page "/lb/targetgroups/{Id:guid}"


<GenericDetailview Title="@_item.Name" Breadcrumbs="@_breadcrumbs" Actions="@_actions">
    <DetailContent>
    </DetailContent>
    <TabContent>
        <MudTabPanel Text="Targets">
            <MudDataGrid T="Target" Outlined="true" Items="_item.Targets" Hover="true">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Targets</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" DropShadow="false" Color="Color.Primary" OnClick="AddTarget">Add target</MudButton>
                </ToolBarContent>
                <Columns>
                    <PropertyColumn Property="t => t.Host.Value" Title="Host" Editable="false" />
                    <PropertyColumn Property="t => t.Port" Title="Port" />
                    <TemplateColumn CellClass="d-flex justify-end">
                        <CellTemplate>
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="@(() => ConfirmDeleteTarget(context.Item))" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </MudTabPanel>
    </TabContent>
</GenericDetailview>


@code {
    [Parameter]
    public Guid Id { get; set; }

    private TargetGroup _item;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Target groups", href: "/lb/targetgroups", icon: Icons.Material.Filled.AltRoute)
    };

    private List<ActionItem> _actions = new List<ActionItem> {};

    protected override async Task OnInitializedAsync()
    {
        _item = await _loadBalancerService.GetTargetGroup(Id);
        if(_item == null)
        {
            _navigationManager.NavigateTo("/lb/targetgroups");
            _snackbar.Add($"Target group {Id} not found", Severity.Error);
        }

        _breadcrumbs.Add(new BreadcrumbItem(_item.Name, href: null, disabled: true));

        _actions = new List<ActionItem>
        {
            new ActionItem() { Name="Edit", Href=$"/lb/targetgroups/{Id}/edit" },
            new ActionItem() { Name="Delete", OnClick=ConfirmDelete }
        };
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the target group? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = _dialogService.Show<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await _loadBalancerService.DeleteTargetGroup(_item);
            await _loadBalancerService.ApplyConfiguration();
            _navigationManager.NavigateTo("/lb/targetgroups");
        }
    }

    private async Task AddTarget()
    {
        var target = new Target();
        var parameters = new DialogParameters<TargetDialog>();
        parameters.Add(x => x.Target, target);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = _dialogService.Show<TargetDialog>("Add target", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            _item.Targets.Add(target);
            await _loadBalancerService.UpdateTargetGroup(_item);
            await _loadBalancerService.ApplyConfiguration();
        }
    }

    private async Task ConfirmDeleteTarget(Target target)
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the target? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = _dialogService.Show<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            _item.Targets.Remove(target);
            await _loadBalancerService.UpdateTargetGroup(_item);
            await _loadBalancerService.ApplyConfiguration();
        }
    }
}