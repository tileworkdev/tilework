@using System.Linq

@using AutoMapper

@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Models
@using Tilework.LoadBalancing.Interfaces

@namespace Tilework.Ui.Components.Pages

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ILoadBalancerService _loadBalancerService
@inject IMapper Mapper

@page "/lb/loadbalancers/new"

<PageTitle>New balancer</PageTitle>

<GenericEditview Models="@(new EditFormModel[] { new EditFormModel(form) })" Title="New load balancer" Breadcrumbs="@_breadcrumbs"
                OnCancel="@(async () => NavigationManager.NavigateTo("/lb/loadbalancers"))" OnValidSubmit="OnSubmit" />

@code {
    NewLoadBalancerForm form = new NewLoadBalancerForm();

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Load balancers", href: "/lb/loadbalancers", icon: Icons.Material.Filled.AltRoute),
        new BreadcrumbItem("Create new", href: null, disabled: true, icon: Icons.Material.Filled.AltRoute)
    };


    private async Task OnSubmit()
    {
        try
        {
            var item = Mapper.Map<LoadBalancerDTO>(form);
            item = await _loadBalancerService.AddLoadBalancer(item);
            await _loadBalancerService.ApplyConfiguration(item.Id);

            NavigationManager.NavigateTo("/lb/loadbalancers");
            Snackbar.Add("Load balancer added successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            Snackbar.Add($"Failed to add load balancer: {ex.Message}", Severity.Error);
        }
    }
}
