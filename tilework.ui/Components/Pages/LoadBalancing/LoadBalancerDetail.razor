@using System
@using System.Linq

@using Tilework.Core.Enums
@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Interfaces
@using Tilework.LoadBalancing.Models

@using Tilework.CertificateManagement.Interfaces
@using Tilework.CertificateManagement.Models


@using Tilework.Ui.Services
@using Tilework.Ui.Components.Shared

@namespace Tilework.Ui.Components.Pages

@inject ILoadBalancerService _loadBalancerService
@inject IDialogService _dialogService
@inject NavigationManager _navigationManager
@inject ISnackbar _snackbar
@inject ICertificateManagementService _certificateService

@page "/lb/loadbalancers/{Id:guid}"


<PageTitle>Load balancer details</PageTitle>

<GenericDetailview Title="@_item.Name" Breadcrumbs="@_breadcrumbs" Actions="@_actions">
    <DetailContent>
        <MudGrid>
            <MudItem xs="4">
                <MudText Typo="Typo.subtitle2">Type</MudText>
                <MudText Typo="Typo.body2">@(_item.Type == LoadBalancerType.APPLICATION ? "Application" : "Network")</MudText>
            </MudItem>
            <MudItem xs="4">
                <MudText Typo="Typo.subtitle2">Status</MudText>
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                @if (_item.Enabled)
                {
                    <MudIcon Style="@($"color:{Colors.Green.Darken2};")"  Icon="@Icons.Material.Outlined.CheckCircle" Size="Size.Small"/>
                    <MudText Style="@($"color:{Colors.Green.Darken2};")" Typo="Typo.body2">Enabled</MudText>
                }
                else
                {
                    <MudIcon Style="@($"color:{Colors.Gray.Darken1};")" Icon="@Icons.Material.Outlined.StopCircle" Size="Size.Small"/>
                    <MudText Style="@($"color:{Colors.Gray.Darken1};")" Typo="Typo.body2">Disabled</MudText>
                }
                </MudStack>
            </MudItem>
        </MudGrid>
    </DetailContent>
    <TabContent>
        <MudTabPanel Text="Rules">
            <MudDataGrid T="RuleDTO" Outlined="true" Items="_rules" Hover="true">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Rules</MudText>
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" DropShadow="false" Color="Color.Primary" OnClick="AddRule">Add rule</MudButton>
                </ToolBarContent>
                <Columns>
                    <TemplateColumn Title="Priority">
                        <CellTemplate>
                            @context.Item.Priority
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Conditions">
                        <CellTemplate>
                            @for (int i = 0; i < context.Item.Conditions.Count; i++)
                            {
                                var condition = context.Item.Conditions[i];

                                <div>
                                    <strong>@condition.Type.GetDescription()</strong>
                                    &#61;
                                    @for (int j = 0; j < condition.Values.Count; j++)
                                    {
                                        @condition.Values[j]
                                        @if (j != condition.Values.Count - 1)
                                        {
                                            <strong> OR </strong>
                                        }
                                    }
                                </div>

                                @if (i != context.Item.Conditions.Count - 1)
                                {
                                    <div><strong>AND</strong></div>
                                }
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Action">
                        <CellTemplate>
                            @if(context.Item.Action?.Type == RuleActionType.Forward)
                            {
                                var targetGroup = _loadBalancerService.GetTargetGroup(context.Item.TargetGroup.Value).Result;
                                <span>Forward to <strong>@targetGroup.Name</strong></span>
                            }
                            else if(context.Item.Action?.Type == RuleActionType.Redirect)
                            {
                                <span>
                                    Redirect <strong>@context.Item.Action?.RedirectStatusCode</strong>
                                    to <strong>@context.Item.Action?.RedirectUrl</strong>
                                </span>
                            }
                            else if(context.Item.Action?.Type == RuleActionType.FixedResponse)
                            {
                                <span>Fixed response <strong>@context.Item.Action?.FixedResponseStatusCode</strong></span>
                            }
                            else if(context.Item.Action?.Type == RuleActionType.Reject)
                            {
                                <span>Reject connection</span>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn CellClass="d-flex justify-end">
                        <CellTemplate>
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@(() => EditRule(context.Item))" />
                            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="@(() => ConfirmDeleteRule(context.Item))" />
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </MudTabPanel>
        @if(_showCertificates)
        {
            <MudTabPanel Text="Certificates">
                <MudDataGrid T="CertificateDTO" Outlined="true" Items="_certificates" Hover="true">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Certificates</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Filled" DropShadow="false" Color="Color.Primary" OnClick="AddCertificate">Add certificate</MudButton>
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Property="t => t.Name" Title="Name" Editable="false" />
                        <PropertyColumn Property="t => t.Fqdn" Title="FQDN" Editable="false" />
                        <TemplateColumn CellClass="d-flex justify-end">
                            <CellTemplate>
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="@(() => ConfirmDeleteCertificate(context.Item))" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudTabPanel>
        }
        <MudTabPanel Text="Monitoring">

            <TimeSeriesChartPanel Title="Monitoring" LoadData="LoadMonitoringCharts" />
        </MudTabPanel>

    </TabContent>
</GenericDetailview>



@code {
    [Parameter]
    public Guid Id { get; set; }

    private LoadBalancerDTO _item;
    private List<RuleDTO> _rules = new();
    private List<CertificateDTO> _certificates = new();
    private bool _showCertificates;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Load balancers", href: "/lb/loadbalancers", icon: Icons.Material.Filled.AltRoute)
    };

    private List<ActionItem> _actions = new List<ActionItem>();

    private int GetMaxRulePriority() => _rules.Count() > 0 ? _rules.Max(p => p.Priority) + 1 : 0;

    protected override async Task OnInitializedAsync()
    {
        _item = await _loadBalancerService.GetLoadBalancer(Id);
        if(_item == null)
        {
            return;
        }

        _showCertificates = _item.Protocol == LoadBalancerProtocol.HTTPS || _item.Protocol == LoadBalancerProtocol.TLS;

        await GetRules();
        if(_showCertificates)
        {
            await GetCertificates();
        }

        _breadcrumbs.Add(new BreadcrumbItem(_item.Name, href: null, disabled: true));

        SetActions();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        if(_item == null)
        {
            _snackbar.Add($"Load balancer {Id} not found", Severity.Error);
            _navigationManager.NavigateTo("/lb/loadbalancers");
            return;
        }
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the load balancer? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try {
                await _loadBalancerService.DeleteLoadBalancer(_item.Id);
                await _loadBalancerService.ApplyConfiguration();
                _navigationManager.NavigateTo("/lb/loadbalancers");
                _snackbar.Add($"Load balancer deleted successfully", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to delete load balancer: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task AddRule()
    {
        var rule = new RuleDTO();
        var parameters = new DialogParameters<RuleDialog>();

        var maxPriorty = GetMaxRulePriority();

        // By default the new rule should have the last priority
        rule.Priority = GetMaxRulePriority();

        parameters.Add(x => x.Rule, rule);
        parameters.Add(x => x.TargetGroups, await GetRuleTargetGroups());
        parameters.Add(x => x.Protocol, _item.Protocol);
        parameters.Add(x => x.Type, _item.Type);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<RuleDialog>("Add rule", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try
            {
                if(rule.Priority < 0)
                    rule.Priority = 0;
                if(rule.Priority > maxPriorty)
                    rule.Priority = maxPriorty;

                await _loadBalancerService.AddRule(_item, rule);
                await GetRules();
                await _loadBalancerService.ApplyConfiguration(_item.Id);
                _snackbar.Add("Rule added successfully!", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to add rule: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EditRule(RuleDTO rule)
    {
        var maxPriorty = GetMaxRulePriority();

        var ruleEdit = new RuleDTO
        {
            Id = rule.Id,
            Priority = rule.Priority,
            LoadBalancer = rule.LoadBalancer,
            TargetGroup = rule.TargetGroup,
            Action = new RuleAction
            {
                Type = rule.Action.Type,
                RedirectUrl = rule.Action.RedirectUrl,
                RedirectStatusCode = rule.Action.RedirectStatusCode,
                FixedResponseStatusCode = rule.Action.FixedResponseStatusCode,
                FixedResponseContentType = rule.Action.FixedResponseContentType,
                FixedResponseBody = rule.Action.FixedResponseBody
            },
            Conditions = rule.Conditions.Select(c => new Condition
            {
                Type = c.Type,
                Values = c.Values.ToList()
            }).ToList()
        };

        var parameters = new DialogParameters<RuleDialog>();
        parameters.Add(x => x.Rule, ruleEdit);
        parameters.Add(x => x.TargetGroups, await GetRuleTargetGroups());
        parameters.Add(x => x.Protocol, _item.Protocol);
        parameters.Add(x => x.Type, _item.Type);
        parameters.Add(x => x.Title, "Edit rule");
        parameters.Add(x => x.ButtonText, "Save");
        parameters.Add(x => x.Icon, Icons.Material.Filled.Edit);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<RuleDialog>("Edit rule", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try
            {
                if(ruleEdit.Priority < 0)
                    ruleEdit.Priority = 0;
                if(ruleEdit.Priority > maxPriorty)
                    ruleEdit.Priority = maxPriorty;

                await _loadBalancerService.UpdateRule(_item, ruleEdit);
                await GetRules();
                await _loadBalancerService.ApplyConfiguration(_item.Id);
                _snackbar.Add("Rule updated successfully!", Severity.Success);
            }
            catch(Exception ex)
            {
                _snackbar.Add($"Failed to update rule: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ConfirmDeleteRule(RuleDTO rule)
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the rule? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await _loadBalancerService.RemoveRule(_item, rule);
            await GetRules();
            await _loadBalancerService.ApplyConfiguration(_item.Id);
        }
    }

    private async Task AddCertificate()
    {
        var parameters = new DialogParameters<CertificateDialog>();
        parameters.Add(x => x.Certificates, await GetAvailableCertificates());

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<CertificateDialog>("Add certificate", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            var cert = (Guid) result.Data;
            await _loadBalancerService.AddCertificate(_item, cert);
            await GetCertificates();
            await _loadBalancerService.ApplyConfiguration(_item.Id);
        }
    }

    private async Task ConfirmDeleteCertificate(CertificateDTO certificate)
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the certificate from the load balancer? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await _dialogService.ShowAsync<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await _loadBalancerService.RemoveCertificate(_item, certificate.Id);
            await GetCertificates();
            await _loadBalancerService.ApplyConfiguration();
        }
    }

    private async Task<List<CertificateDTO>> GetAvailableCertificates()
    {
        var all = await _certificateService.GetCertificates();
        var installed = await _loadBalancerService.GetCertificates(_item);
        return all.Where(c => !installed.Select(ic => ic.Id).Contains(c.Id)).ToList();
    }

    private async Task<List<TargetGroupDTO>> GetRuleTargetGroups()
    {
        var protocols = TargetGroupProtocolRules.GetAllowedProtocols(_item.Type);

        return (await _loadBalancerService.GetTargetGroups())
            .Where(tg => protocols.Contains(tg.Protocol))
            .ToList();
    }

    private async Task Enable()
    {
        try {
            await _loadBalancerService.EnableLoadBalancer(_item.Id);
            _item = await _loadBalancerService.GetLoadBalancer(Id);
            _snackbar.Add("Load balancer enabled successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            _snackbar.Add($"Failed to enable load balancer: {ex.Message}", Severity.Error);
        }
        SetActions();
    }

    private async Task Disable()
    {
        try {
            await _loadBalancerService.DisableLoadBalancer(_item.Id);
            _item = await _loadBalancerService.GetLoadBalancer(Id);
            _snackbar.Add("Load balancer disabled successfully!", Severity.Success);
        }
        catch(Exception ex)
        {
            _snackbar.Add($"Failed to disable load balancer: {ex.Message}", Severity.Error);
        }

        SetActions();
    }

    private void SetActions()
    {
        _actions = new List<ActionItem>
        {
            new ActionItem() { Name="Edit", Href=$"/lb/loadbalancers/{Id}/edit" },
            new ActionItem() { Name="Delete", OnClick=ConfirmDelete },
            new ActionItem()
            {
                Name = _item.Enabled ? "Disable" : "Enable",
                OnClick = _item.Enabled ? Disable : Enable
            }
        };
    }

    private async Task GetRules()
    {
        _rules = await _loadBalancerService.GetRules(_item);
    }

    private async Task GetCertificates()
    {
        _certificates = await _loadBalancerService.GetCertificates(_item);
    }

    private async Task<List<TimeSeriesChartData>> LoadMonitoringCharts(DateTimeOffset from, DateTimeOffset to, TimeSpan interval)
    {
        var charts = new List<TimeSeriesChartData>();
        var includeHttpMetrics = _item?.Type == LoadBalancerType.APPLICATION;
        List<LoadBalancingMonitorData>? data = await _loadBalancerService.GetLoadBalancerMonitoringData(_item.Id, interval, from, to)
            ?? new List<LoadBalancingMonitorData>();

        Dictionary<string, Dictionary<DateTimeOffset, double>> chartData = new()
        {
            ["Sessions"] = new Dictionary<DateTimeOffset, double>(),
            ["Bytes in"] = new Dictionary<DateTimeOffset, double>(),
            ["Bytes out"] = new Dictionary<DateTimeOffset, double>(),
        };

        if (includeHttpMetrics)
        {
            chartData["Requests"] = new Dictionary<DateTimeOffset, double>();
            chartData["HTTP 1xx"] = new Dictionary<DateTimeOffset, double>();
            chartData["HTTP 2xx"] = new Dictionary<DateTimeOffset, double>();
            chartData["HTTP 3xx"] = new Dictionary<DateTimeOffset, double>();
            chartData["HTTP 4xx"] = new Dictionary<DateTimeOffset, double>();
            chartData["HTTP 5xx"] = new Dictionary<DateTimeOffset, double>();
            chartData["HTTP Other"] = new Dictionary<DateTimeOffset, double>();
        }

        foreach (var entry in data.OrderBy(d => d.Timestamp))
        {
            var timestamp = entry.Timestamp.ToUniversalTime();
            
            chartData["Sessions"][timestamp] = entry.Sessions;
            chartData["Bytes in"][timestamp] = entry.BytesIn;
            chartData["Bytes out"][timestamp] = entry.BytesOut;

            if (includeHttpMetrics)
            {
                chartData["Requests"][timestamp] = entry.Requests;
                chartData["HTTP 1xx"][timestamp] = entry.HttpResponses1xx;
                chartData["HTTP 2xx"][timestamp] = entry.HttpResponses2xx;
                chartData["HTTP 3xx"][timestamp] = entry.HttpResponses3xx;
                chartData["HTTP 4xx"][timestamp] = entry.HttpResponses4xx;
                chartData["HTTP 5xx"][timestamp] = entry.HttpResponses5xx;
                chartData["HTTP Other"][timestamp] = entry.HttpResponsesOther;
            }
        }

        foreach(var datapoint in chartData)
        {
            charts.Add(new TimeSeriesChartData { Name = datapoint.Key, Data = datapoint.Value });
        }

        return charts;
    }
}
