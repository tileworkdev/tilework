@using Tilework.LoadBalancing.Persistence.Models
@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Services

@namespace Tilework.Ui.Components.Pages

@inject LoadBalancerService _loadBalancerService
@inject IDialogService _dialogService
@inject NavigationManager _navigationManager
@inject ISnackbar _snackbar

@page "/lb/loadbalancers/{Id:guid}"

<GenericDetailview Title="@_item.Name" Breadcrumbs="@_breadcrumbs" Actions="@_actions">
    <DetailContent>
        <MudGrid Spacing="5">
            <MudItem>
                <MudText Typo="Typo.subtitle2">Type</MudText>
                <MudText Typo="Typo.body2">@(_item is ApplicationLoadBalancer appBalancer ? "Application" : "Network")</MudText>
            </MudItem>
            <MudItem>
                <MudText Typo="Typo.subtitle2">Status</MudText>
                @if (_item.Enabled)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Enabled</MudChip>
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error">Disabled</MudChip>
                }
            </MudItem>
        </MudGrid>
    </DetailContent>
    <TabContent>
        @if(_item is ApplicationLoadBalancer appBalancer)
        {
            <MudTabPanel Text="Rules">
                <MudDataGrid T="Rule" Outlined="true" Items="appBalancer.Rules" Hover="true">
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Rules</MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Filled" DropShadow="false" Color="Color.Primary" OnClick="AddRule">Add rule</MudButton>
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Property="t => t.Hostname" Title="Hostname" Editable="false" />
                        <PropertyColumn Property="t => t.TargetGroup.Name" Title="Target group" />
                        <TemplateColumn CellClass="d-flex justify-end">
                            <CellTemplate>
                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudTabPanel>
        }
        <MudTabPanel Text="Certificates">
            <MudText>TODO</MudText>
        </MudTabPanel>
        <MudTabPanel Text="Monitoring">
            <MudText>TODO</MudText>
        </MudTabPanel>

    </TabContent>
</GenericDetailview>



@code {
    [Parameter]
    public Guid Id { get; set; }

    private BaseLoadBalancer _item;

    private List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Load balancers", href: "/lb/loadbalancers", icon: Icons.Material.Filled.AltRoute)
    };

    private List<ActionItem> _actions = new List<ActionItem> {};

    protected override async Task OnInitializedAsync()
    {
        var _item = await _loadBalancerService.GetLoadBalancer(Id);
        if(_item == null)
        {
            _navigationManager.NavigateTo("/lb/loadbalancers");
            _snackbar.Add($"Load balancer {Id} not found", Severity.Error);
        }
            
        
        _breadcrumbs.Add(new BreadcrumbItem(_item.Name, href: null, disabled: true));

        _actions = new List<ActionItem>
        {
            new ActionItem() { Name="Edit", Href=$"/lb/loadbalancers/{Id}/edit" },
            new ActionItem() { Name="Delete", OnClick=ConfirmDelete },
            new ActionItem() {
                Name= _item.Enabled ? "Disable" : "Enable",
                OnClick= _item.Enabled ? Disable : Enable }
        };
    }

    private async Task ConfirmDelete()
    {
        var parameters = new DialogParameters<ConfirmDialog>();
        parameters.Add(x => x.ContentText, "Do you really want to delete the load balancer? This process cannot be undone.");
        parameters.Add(x => x.ButtonText, "Delete");
        parameters.Add(x => x.Color, Color.Error);

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = _dialogService.Show<ConfirmDialog>("Delete", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await _loadBalancerService.DeleteLoadBalancer(_item);
            await _loadBalancerService.ApplyConfiguration();
            _navigationManager.NavigateTo("/lb/loadbalancers");
        }
    }

    private async Task AddRule()
    {
        var rule = new Rule();
        var parameters = new DialogParameters<RuleDialog>();
        parameters.Add(x => x.Rule, rule);
        parameters.Add(x => x.TargetGroups, await GetAlbTargetGroups());

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = _dialogService.Show<RuleDialog>("Add rule", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            if(_item is ApplicationLoadBalancer appBalancer)
            {
                appBalancer.Rules.Add(rule);
                await _loadBalancerService.UpdateLoadBalancer(appBalancer);
            }
            else
            {
                _snackbar.Add("Can only add rules to application load balancers", Severity.Error);
            }
        }
    }

    private async Task<List<TargetGroup>> GetAlbTargetGroups()
    {
        var protocols = new List<TargetGroupProtocol> {
            TargetGroupProtocol.HTTP,
            TargetGroupProtocol.HTTPS
        };
        return (await _loadBalancerService.GetTargetGroups()).Where(tg => protocols.Contains(tg.Protocol)).ToList();
    }

    private async Task Enable()
    {
        _item.Enabled = true;
        await _loadBalancerService.UpdateLoadBalancer(_item);
        await _loadBalancerService.ApplyConfiguration();
    }
    
    private async Task Disable()
    {
        _item.Enabled = false;
        await _loadBalancerService.UpdateLoadBalancer(_item);
        await _loadBalancerService.ApplyConfiguration();
    }
}
