@using Tilework.LoadBalancing.Enums
@using Tilework.LoadBalancing.Persistence.Models
@using Tilework.Ui.Enums
@using System.Linq
@using System.Collections.Generic

@namespace Tilework.Ui.Components.Forms

<MudPaper Class="mb-4 p-4">
    <MudGrid>
        <MudItem xs="4">
            <MudSelect T="ConditionType" @bind-Value="Condition.Type" Label="Condition type" Variant="Variant.Outlined" Required="true">
                @foreach (var type in AvailableTypes)
                {
                    <MudSelectItem Value="@type">@type.GetDescription()</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="7">
            <MudStack Spacing="2">
                @for (var i = 0; i < Condition.Values.Count; i++)
                {
                    var index = i;
                    <MudGrid>
                        <MudItem xs="11">
                            <MudTextField @bind-Value="Condition.Values[index]" Label="Value" Variant="Variant.Outlined" Required="true" />
                        </MudItem>
                        <MudItem xs="1" Class="d-flex align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Variant="Variant.Outlined" OnClick="@(() => RemoveValue(index))" />
                        </MudItem>
                    </MudGrid>
                }
                <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="AddValue" />
            </MudStack>
        </MudItem>
        <MudItem xs="1" Class="d-flex align-center justify-end">
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Variant="Variant.Outlined" OnClick="OnDelete" />
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter] public Condition Condition { get; set; }
    [Parameter] public IEnumerable<ConditionType> UsedTypes { get; set; } = Enumerable.Empty<ConditionType>();
    [Parameter] public EventCallback OnDelete { get; set; }

    private IEnumerable<ConditionType> AvailableTypes => Enum.GetValues<ConditionType>().Except(UsedTypes);

    protected override void OnParametersSet()
    {
        if (Condition?.Values == null || Condition.Values.Count == 0)
        {
            Condition.Values ??= new List<string>();
            Condition.Values.Add(string.Empty);
        }
    }

    void AddValue()
    {
        Condition.Values.Add(string.Empty);
    }

    void RemoveValue(int index)
    {
        if (index >= 0 && index < Condition.Values.Count)
        {
            Condition.Values.RemoveAt(index);
            if (Condition.Values.Count == 0)
            {
                Condition.Values.Add(string.Empty);
            }
        }
    }
}
