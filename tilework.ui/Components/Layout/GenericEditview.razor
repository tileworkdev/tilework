@using Microsoft.AspNetCore.Components.Forms
@using System.Linq
@using Tilework.Ui.Models

@namespace Tilework.Ui.Components.Layout

<MudBreadcrumbs Items="Breadcrumbs" Separator=">"></MudBreadcrumbs>

<MudStack Spacing="3">
    <MudText Typo="Typo.h6">@Title</MudText>

    <MudGrid Spacing="3">
        @foreach (var model in _models)
        {
            <MudItem xs="12">
                <MudCard Outlined="true">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.subtitle1">@GetModelTitle(model)</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <EditForm EditContext="@_editContexts[model]">
                            <DataAnnotationsValidator />
                            <GenericFormRenderer Model="@model" OnChange="OnChange" />
                        </EditForm>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }

        <MudItem xs="12">
            <MudGrid Justify="Justify.FlexEnd">
                <MudItem>
                    <MudButton Variant="Variant.Filled" DropShadow="false" ButtonType="ButtonType.Button" OnClick="OnCancelClicked">Cancel</MudButton>
                </MudItem>
                <MudItem>
                    <MudButton Variant="Variant.Filled" DropShadow="false" Color="Color.Primary" OnClick="OnSaveClicked">Save</MudButton>
                </MudItem>
            </MudGrid>
        </MudItem>
    </MudGrid>
</MudStack>

@code {
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public List<BreadcrumbItem> Breadcrumbs { get; set; } = new List<BreadcrumbItem>();
    [Parameter] public Func<Task>? OnValidSubmit { get; set; }
    [Parameter] public Func<Task>? OnCancel { get; set; }
    [Parameter] public EventCallback<(string PropertyName, object? Value)> OnChange { get; set; }
    [Parameter] public IEnumerable<BaseForm> Models { get; set; } = Enumerable.Empty<BaseForm>();

    private IReadOnlyList<BaseForm> _models = Array.Empty<BaseForm>();
    private Dictionary<BaseForm, EditContext> _editContexts = new Dictionary<BaseForm, EditContext>();

    protected override void OnParametersSet()
    {
        _models = Models?.ToList() ?? new List<BaseForm>();
        _editContexts = _models.ToDictionary(model => model, model => new EditContext(model));
    }

    private string GetModelTitle(BaseForm model)
    {
        return model.GetType().Name;
    }

    private async Task OnSaveClicked()
    {
        foreach (var model in _models)
        {
            if (_editContexts.TryGetValue(model, out var context))
            {
                if (!context.Validate())
                    return;
            }
        }

        if (OnValidSubmit != null)
            await OnValidSubmit();
    }

    private async Task OnCancelClicked()
    {
        if (OnCancel != null)
            await OnCancel();
    }
}
